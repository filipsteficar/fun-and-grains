---
// Layouts
import Layout from "../../layouts/Layout.astro";
// Components
import PageTitle from "../../components/PageTitle.astro";
import RecipeCard from "../../components/RecipeCard.astro";
// Astro Types
import type { Page, PaginateFunction } from 'astro';
// Data Imports
import { siteData } from "../../global";
// Directus Imports
import directus from "../../lib/directus";
import { readItems } from "@directus/sdk";
// Post Interface
interface Recipe {
    id: string;
    title: string;
    slug: string;
    cover: string;
    cover_alt_text: string;
    prep_time: number;
    difficulty: string;
    date_created: string;
    status: string;
    author?: {
        id: string;
        name: string;
        slug: string;
    };
}
// Query Posts With Pagination
export async function getStaticPaths({ paginate }: { paginate: PaginateFunction }) {
    const posts = await directus.request(
        readItems("recipes", {
            fields: [
                "id",
                "title",
                "slug",
                "cover",
                "cover_alt_text",
                "prep_time",
                "difficulty",
                "date_created",
                "status",
                {
                    author: ["id", "name", "slug"]
                }
            ],
            filter: {
                status: {
                    _eq: "published"
                }
            },
            sort: ["-date_created"],
            limit: -1,
        })
    );

    // Return Paginated Paths With X Posts Per Page
    return paginate(posts, { pageSize: 9 });
}
// Page Prop
const { page } = Astro.props as { page: Page<Recipe> };
// Directus URL
const CMS = "https://directus-v0gswo0csw84sck0cc8c4oo0.apollo.filipsteficar.com";

// Prep Time Helper Function
function formatTime(minutes: number): string {
    if (minutes < 60) {
        return `${minutes}m`;
    }
    
    const hours = Math.floor(minutes / 60);
    const remainingMinutes = minutes % 60;
    
    if (remainingMinutes === 0) {
        return `${hours}h`;
    }
    
    return `${hours}h ${remainingMinutes.toString().padStart(2, '0')}m`;
}
---
<Layout pageTitle=`Recipes - ${siteData.name}`>
    <PageTitle pageTitle="Recipes" />
    <section class="@container">
        <div class="gap-4 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 mx-auto mt-4 px-4 container">
            {page.data.map((singleRecipe: Recipe) => (
                <RecipeCard
                imgSRC={`${CMS}/assets/${singleRecipe.cover}?width=1200&quality=80&format=webp`}
                difficulty={singleRecipe.difficulty}
                prepTime={formatTime(singleRecipe.prep_time)}
                title={singleRecipe.title}
                author={singleRecipe.author?.name || "Unknown Author"}
                date={new Date(singleRecipe.date_created).toLocaleDateString('en-GB')}
                href={`/recipes/${singleRecipe.slug}`}
                />
            ))}
        </div>
        <!-- Pagination Controls -->
        {page.lastPage > 1 && (
            <div class="mt-4 mb-4">
                <nav class="flex flex-row justify-between items-center gap-4 mx-auto px-4 container">
                    {page.url.prev && (
                        <a href={page.url.prev} class="bg-zinc-100 hover:bg-zinc-200 dark:bg-zinc-900 dark:hover:bg-zinc-800 px-4 py-2 rounded-xl transition-colors duration-500 ease-in-out">Previous</a>
                    )}
                    
                    <p class="font-heading font-semibold uppercase">Page {page.currentPage} of {page.lastPage}</p>
                    
                    {page.url.next && (
                        <a href={page.url.next} class="bg-zinc-100 hover:bg-zinc-200 dark:bg-zinc-900 dark:hover:bg-zinc-800 px-4 py-2 rounded-xl transition-colors duration-500 ease-in-out">Next</a>
                    )}
                </nav>
            </div>
        )}
    </section>
</Layout>